<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù…Ø­Ø±Ø± PDF Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ | Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø·ÙˆØ±Ø©</title>
    
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>

    <style>
        :root {
            --primary: #4834d4; --accent: #686de0; --success: #2ecc71; --danger: #eb4d4b;
            --bg: #f5f6fa; --card: #ffffff; --text: #2f3640;
        }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 10px; display: flex; flex-direction: column; align-items: center; }
        .container { background: var(--card); width: 100%; max-width: 600px; padding: 20px; border-radius: 24px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); box-sizing: border-box; }
        h1 { text-align: center; font-size: 1.3rem; margin-bottom: 20px; color: var(--primary); }
        
        .upload-container { display: flex; gap: 10px; margin-bottom: 15px; }
        .upload-section { border: 2px dashed #dcdde1; padding: 15px; border-radius: 18px; text-align: center; cursor: pointer; background: #fafafa; flex: 1; font-weight: bold; font-size: 0.85rem; display: flex; align-items: center; justify-content: center; }
        .btn-camera { background: var(--primary); color: white; border: none; border-radius: 18px; padding: 0 20px; cursor: pointer; font-weight: bold; font-size: 0.85rem; display: flex; align-items: center; gap: 5px; }

        .btn { border: none; border-radius: 12px; padding: 12px; font-size: 0.95rem; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s; color: white; width: 100%; }
        .btn-gps { background: var(--accent); margin-bottom: 10px; }
        .btn-merge { background: var(--success); }
        .btn-images { background: #f39c12; }

        #fileList { margin-top: 15px; width: 100%; }
        .file-item { background: #fff; margin-bottom: 10px; padding: 12px; border-radius: 16px; border: 1px solid #edf2f7; display: flex; align-items: center; gap: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.03); }
        .drag-handle { cursor: grab; color: #ccc; font-size: 1.4rem; }
        .thumb-wrapper { width: 55px; height: 55px; border-radius: 8px; overflow: hidden; border: 1px solid #eee; background: #f9f9f9; flex-shrink: 0; cursor: pointer; }
        .thumb-wrapper img { width: 100%; height: 100%; object-fit: cover; }
        
        .item-content-stack { flex: 1; display: flex; flex-direction: column; gap: 8px; min-width: 0; }
        .page-name-input { width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 0.85rem; outline: none; box-sizing: border-box; }
        
        .item-controls-row { display: flex; align-items: center; justify-content: space-between; gap: 10px; }
        .checkbox-group { display: flex; align-items: center; gap: 5px; font-size: 0.75rem; font-weight: bold; color: var(--primary); }
        .btns-row { display: flex; gap: 6px; }
        .btn-icon { background: #f1f2f6; border: none; cursor: pointer; font-size: 0.95rem; padding: 6px; border-radius: 8px; display: flex; align-items: center; justify-content: center; }

        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); backdrop-filter: blur(5px); z-index: 9999; justify-content: center; align-items: center; }
        .modal-content { background: white; width: 90%; max-width: 450px; padding: 20px; border-radius: 20px; text-align: center; }
        
        .gps-inputs-row { margin-bottom: 10px; }
        .gps-inputs-row input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; text-align: center; font-size: 0.9rem; box-sizing: border-box; }
        
        .paste-wrapper { display: flex; gap: 5px; margin-bottom: 15px; }
        .paste-wrapper input { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 10px; text-align: center; }
        .btn-paste { background: #f1f2f6; border: 1px solid #ddd; border-radius: 10px; padding: 0 15px; cursor: pointer; font-size: 0.8rem; font-weight: bold; }

        #previewBox { width: 100%; max-height: 65vh; overflow-y: auto; margin-top: 10px; border-radius: 10px; background: #f9f9f9; }
        #previewBox img { width: 100%; height: auto; }

        .main-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; width: 100%; }
        .loading { display: none; text-align: center; color: var(--primary); font-weight: bold; padding: 10px; font-size: 0.9rem; }
    </style>
</head>
<body>

<div class="container">
    <h1>Ù…Ø­Ø±Ø± PDF Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ</h1>

    <div class="upload-container">
        <div class="upload-section" onclick="document.getElementById('fileInput').click()">
            <span>ğŸ“‚ Ø¥Ø¶Ø§ÙØ© Ù…Ù„ÙØ§Øª PDF Ø£Ùˆ ØµÙˆØ±</span>
            <input type="file" id="fileInput" multiple accept="image/*,application/pdf" style="display:none">
        </div>
        <button class="btn-camera" onclick="document.getElementById('cameraInput').click()">ğŸ“¸ ØªØµÙˆÙŠØ±</button>
        <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display:none">
    </div>

    <button class="btn btn-gps" onclick="startGPS()">ğŸ“ Ø¥Ø¶Ø§ÙØ© ØµÙØ­Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹ (GPS)</button>

    <div style="background: #f9f9f9; padding: 12px; border-radius: 15px; border: 1px solid #eee; margin-bottom:15px;">
        <textarea id="textPageInput" rows="2" style="width:100%; padding:10px; border-radius:10px; border:1px solid #ddd; outline:none; font-family:inherit; resize: none;" placeholder="Ø§ÙƒØªØ¨ Ù†ØµØ§Ù‹ Ù‡Ù†Ø§ (ÙŠØªÙ… ØªÙ‚Ø³ÙŠÙ…Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹)..."></textarea>
        <button class="btn" style="background:var(--primary); margin-top:8px; height:36px; font-size:0.85rem;" onclick="handleTextAddition()">Ø¥Ø¯Ø±Ø§Ø¬ Ù†Øµ</button>
    </div>

    <input type="text" id="fileNameInput" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ..." value="merged_document" style="width:100%; padding:10px; border-radius:10px; border:1px solid #eee; box-sizing:border-box; outline:none;">

    <div id="fileList"></div>

    <div id="status" class="loading">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...</div>

    <div class="main-actions">
        <button id="imgBtn" class="btn btn-images" onclick="saveAsImages()" disabled>ğŸ–¼ï¸ Ø­ÙØ¸ ÙƒØµÙˆØ± Ù…Ù†ÙØ±Ø¯Ø©</button>
        <button id="mergeBtn" class="btn btn-merge" onclick="mergeAll()" disabled>ğŸš€ Ø­ÙØ¸ ÙƒÙ…Ù„Ù PDF</button>
    </div>
</div>

<a href="new_customer.html" style="background: #2f3542; color: white; width: 100%; max-width: 600px; margin-top: 15px; text-decoration: none; text-align: center; display: block; border-radius: 12px; padding: 12px; font-weight: bold; font-size: 0.9rem;">New Customer</a>

<!-- Ù†Ø§ÙØ°Ø© GPS Ø§Ù„Ù…Ø¹Ø¯Ù„Ø© -->
<div id="gpsOverlay" class="modal-overlay">
    <div class="modal-content">
        <h3>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹ (Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„)</h3>
        <div class="gps-inputs-row">
            <input type="text" id="coordsInput" placeholder="Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª (Ù…Ø«Ø§Ù„: 30.9975, 40.9967)">
        </div>
        <div class="paste-wrapper">
            <input type="text" id="plusCodeManual" placeholder="Plus Code">
            <button class="btn-paste" onclick="pasteFromClipboard()">ğŸ“‹ Ù„ØµÙ‚</button>
        </div>
        <div style="display:flex; gap:10px;">
            <button class="btn" style="background:#009432; flex:1" onclick="openMapsWindow()">ÙØªØ­ Ø§Ù„Ø®Ø±Ø§Ø¦Ø·</button>
            <button class="btn" style="background:var(--primary); flex:1" onclick="addGPSItem()">ØªØ£ÙƒÙŠØ¯</button>
        </div>
        <button onclick="document.getElementById('gpsOverlay').style.display='none'" style="background:none; border:none; color:red; margin-top:15px; cursor:pointer;">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
</div>

<!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© -->
<div id="previewOverlay" class="modal-overlay">
    <div class="modal-content">
        <h3 id="previewTitle" style="margin-top:0; font-size:1rem;">Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙØ­Ø©</h3>
        <div id="previewBox"></div>
        <button class="btn" style="background:var(--danger); margin-top:15px;" onclick="document.getElementById('previewOverlay').style.display='none'">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
</div>

<script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

    let items = [];

    function wrapText(ctx, text, x, y, maxWidth, lineHeight) {
        const lines = text.split('\n');
        for (let i = 0; i < lines.length; i++) {
            let words = lines[i].split(' ');
            let line = '';
            for (let n = 0; n < words.length; n++) {
                let testLine = line + words[n] + ' ';
                let metrics = ctx.measureText(testLine);
                if (metrics.width > maxWidth && n > 0) {
                    ctx.fillText(line, x, y);
                    line = words[n] + ' ';
                    y += lineHeight;
                } else { line = testLine; }
            }
            ctx.fillText(line, x, y);
            y += lineHeight;
        }
    }

    function updateItemData(idx, field, value) { items[idx][field] = value; }

    function renderUI() {
        const list = document.getElementById('fileList');
        list.innerHTML = '';
        items.forEach((item, idx) => {
            const div = document.createElement('div');
            div.className = 'file-item';
            div.dataset.id = item.id;
            div.innerHTML = `
                <div class="drag-handle">â˜°</div>
                <div class="thumb-wrapper" onclick="showPreview(${idx})"><img src="${item.thumb}" style="transform: rotate(${item.rotation}deg)"></div>
                <div class="item-content-stack">
                    <input type="text" class="page-name-input" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØµÙØ­Ø©..." value="${item.customName}" oninput="updateItemData(${idx}, 'customName', this.value)">
                    <div class="item-controls-row">
                        <div class="checkbox-group">
                            <input type="checkbox" ${item.includeName ? 'checked' : ''} onchange="updateItemData(${idx}, 'includeName', this.checked)">
                            <span>ØªØ¶Ù…ÙŠÙ† Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</span>
                        </div>
                        <div class="btns-row">
                            <button class="btn-icon" onclick="showPreview(${idx})">ğŸ‘ï¸</button>
                            <button class="btn-icon" onclick="rotateItem(${idx})">ğŸ”„</button>
                            <button class="btn-icon" onclick="removeItem(${idx})">ğŸ—‘ï¸</button>
                        </div>
                    </div>
                </div>
            `;
            list.appendChild(div);
        });
        const hasItems = items.length > 0;
        document.getElementById('mergeBtn').disabled = !hasItems;
        document.getElementById('imgBtn').disabled = !hasItems;
    }

    Sortable.create(document.getElementById('fileList'), {
        animation: 150, handle: '.drag-handle',
        onEnd: function() {
            const newOrder = [];
            document.querySelectorAll('.file-item').forEach(el => {
                const item = items.find(i => i.id == el.dataset.id);
                if (item) newOrder.push(item);
            });
            items = newOrder; renderUI();
        }
    });

    async function createTextLabelImage(text, fontSize = 28, color = "#4834d4") {
        const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
        ctx.font = `bold ${fontSize}px Arial`; const textWidth = ctx.measureText(text).width;
        canvas.width = textWidth + 50; canvas.height = fontSize + 50;
        ctx.fillStyle = color; ctx.font = `bold ${fontSize}px Arial`; ctx.textAlign = 'right'; ctx.textBaseline = 'middle'; ctx.direction = 'rtl';
        ctx.fillText(text, canvas.width - 20, canvas.height / 2); return canvas.toDataURL('image/png');
    }

    const handleFiles = async (e) => {
        const files = Array.from(e.target.files);
        for (const file of files) {
            if (file.type === 'application/pdf') {
                const buffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({data: buffer.slice(0)}).promise;
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const viewport = page.getViewport({scale: 0.2});
                    const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
                    canvas.height = viewport.height; canvas.width = viewport.width;
                    await page.render({canvasContext: ctx, viewport: viewport}).promise;
                    items.push({ id: Math.random(), type: 'pdf', customName: "", pageIdx: i-1, data: buffer, thumb: canvas.toDataURL(), rotation: 0, includeName: false });
                }
            } else if (file.type.startsWith('image/')) {
                items.push({ id: Math.random(), type: 'image', customName: "", file: file, thumb: URL.createObjectURL(file), rotation: 0, includeName: false });
            }
        }
        renderUI(); e.target.value = '';
    };

    document.getElementById('fileInput').addEventListener('change', handleFiles);
    document.getElementById('cameraInput').addEventListener('change', handleFiles);

    async function handleTextAddition() {
        const text = document.getElementById('textPageInput').value.trim();
        if (!text) return;
        const canvas = document.createElement('canvas'); canvas.width = 800; canvas.height = 1131;
        const ctx = canvas.getContext('2d'); ctx.fillStyle = 'white'; ctx.fillRect(0, 0, 800, 1131);
        ctx.fillStyle = 'black'; ctx.font = '28px Arial'; ctx.textAlign = 'right'; ctx.direction = 'rtl';
        wrapText(ctx, text, 750, 80, 700, 40);
        items.push({ id: Math.random(), type: 'text_page', customName: "", thumb: canvas.toDataURL(), dataURL: canvas.toDataURL(), rotation: 0, includeName: false });
        document.getElementById('textPageInput').value = ''; renderUI();
    }

    // GPS ÙˆØ¸Ø§Ø¦Ù Ù…Ø­Ø³Ù†Ø© Ù„Ø®Ø§Ù†Ø© ÙˆØ§Ø­Ø¯Ø©
    function startGPS() {
        navigator.geolocation.getCurrentPosition((pos) => {
            document.getElementById('coordsInput').value = pos.coords.latitude + ", " + pos.coords.longitude;
            document.getElementById('gpsOverlay').style.display = 'flex';
        }, () => {
            document.getElementById('gpsOverlay').style.display = 'flex';
        });
    }

    async function pasteFromClipboard() {
        try {
            const text = await navigator.clipboard.readText();
            document.getElementById('plusCodeManual').value = text;
        } catch (err) { alert("ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù„ØµÙ‚ ÙŠØ¯ÙˆÙŠØ§Ù‹."); }
    }

    function parseCoords() {
        const val = document.getElementById('coordsInput').value;
        const parts = val.split(',').map(s => s.trim());
        return { lat: parts[0] || "0", lon: parts[1] || "0" };
    }

    function openMapsWindow() { 
        const c = parseCoords();
        window.open(`https://www.google.com/maps/search/?api=1&query=${c.lat},${c.lon}`, 'Maps', 'width=500,height=600'); 
    }

    async function addGPSItem() {
        const c = parseCoords();
        const plusCode = document.getElementById('plusCodeManual').value.trim() || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
        const content = `GPS LOCATION DATA\nCoordinates: ${c.lat},${c.lon}\nPlus Code: ${plusCode}\nGoogle Maps: https://www.google.com/maps?q=${c.lat},${c.lon}`;
        items.push({ id: Math.random(), type: 'gps', customName: "", content: content, rotation: 0, thumb: await genSimpleThumb("ğŸ“ Location"), includeName: false });
        document.getElementById('gpsOverlay').style.display = 'none'; 
        document.getElementById('plusCodeManual').value = "";
        renderUI();
    }

    async function showPreview(idx) {
        const item = items[idx]; const overlay = document.getElementById('previewOverlay');
        const previewBox = document.getElementById('previewBox');
        overlay.style.display = 'flex'; previewBox.innerHTML = '<p>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>';
        let url = "";
        if (item.type === 'pdf') {
            const pdf = await pdfjsLib.getDocument({data: item.data.slice(0)}).promise;
            const page = await pdf.getPage(item.pageIdx + 1);
            const viewport = page.getViewport({scale: 1.0});
            const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
            canvas.height = viewport.height; canvas.width = viewport.width;
            await page.render({canvasContext: ctx, viewport: viewport}).promise;
            url = canvas.toDataURL();
        } else if (item.type === 'image') { url = URL.createObjectURL(item.file); }
        else if (item.type === 'text_page') { url = item.dataURL; }
        else if (item.type === 'gps') {
            const canvas = document.createElement('canvas'); canvas.width = 500; canvas.height = 600;
            const ctx = canvas.getContext('2d'); ctx.fillStyle = 'white'; ctx.fillRect(0,0,500,600);
            ctx.fillStyle = 'black'; ctx.font = '16px Arial';
            item.content.split('\n').forEach((l, i) => ctx.fillText(l, 20, 40+(i*25)));
            url = canvas.toDataURL();
        }
        previewBox.innerHTML = `<img src="${url}" style="transform: rotate(${item.rotation}deg)">`;
    }

    async function getProcessedCanvas(item) {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        if (item.type === 'pdf') {
            const pdf = await pdfjsLib.getDocument({data: item.data.slice(0)}).promise;
            const page = await pdf.getPage(item.pageIdx + 1);
            const vp = page.getViewport({scale: 2.0});
            canvas.width = vp.width; canvas.height = vp.height;
            await page.render({canvasContext: ctx, viewport: vp}).promise;
        } else if (item.type === 'image') {
            const img = new Image(); img.src = URL.createObjectURL(item.file);
            await new Promise(r => img.onload = r);
            canvas.width = img.width; canvas.height = img.height;
            ctx.drawImage(img, 0, 0);
        } else if (item.type === 'text_page' || item.type === 'gps') {
            const img = new Image();
            if(item.type === 'gps') {
                const gCanvas = document.createElement('canvas'); gCanvas.width = 800; gCanvas.height = 1100;
                const gCtx = gCanvas.getContext('2d'); gCtx.fillStyle = 'white'; gCtx.fillRect(0,0,800,1100);
                gCtx.fillStyle = 'black'; gCtx.font = '24px Arial';
                item.content.split('\n').forEach((l, i) => gCtx.fillText(l, 50, 80+(i*35)));
                img.src = gCanvas.toDataURL();
            } else { img.src = item.dataURL; }
            await new Promise(r => img.onload = r);
            canvas.width = img.width; canvas.height = img.height;
            ctx.drawImage(img, 0, 0);
        }

        const finalCanvas = document.createElement('canvas');
        const fCtx = finalCanvas.getContext('2d');
        const isRot = (item.rotation / 90) % 2 !== 0;
        finalCanvas.width = isRot ? canvas.height : canvas.width;
        finalCanvas.height = isRot ? canvas.width : canvas.height;
        fCtx.translate(finalCanvas.width/2, finalCanvas.height/2);
        fCtx.rotate(item.rotation * Math.PI / 180);
        fCtx.drawImage(canvas, -canvas.width/2, -canvas.height/2);
        fCtx.setTransform(1,0,0,1,0,0);

        if (item.includeName && item.customName) {
            const labelUrl = await createTextLabelImage(item.customName, finalCanvas.width/25);
            const labelImg = new Image(); labelImg.src = labelUrl;
            await new Promise(r => labelImg.onload = r);
            fCtx.drawImage(labelImg, finalCanvas.width - labelImg.width - 20, 20);
        }
        return finalCanvas;
    }

    async function mergeAll() {
        const status = document.getElementById('status'); status.style.display = 'block';
        status.textContent = "Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù PDF...";
        try {
            const { PDFDocument } = PDFLib;
            const pdfDoc = await PDFDocument.create();
            for (const item of items) {
                const canvas = await getProcessedCanvas(item);
                const imgBytes = await fetch(canvas.toDataURL('image/jpeg', 0.85)).then(r => r.arrayBuffer());
                const pdfImg = await pdfDoc.embedJpg(imgBytes);
                const page = pdfDoc.addPage([canvas.width * 0.75, canvas.height * 0.75]);
                page.drawImage(pdfImg, { x: 0, y: 0, width: page.getWidth(), height: page.getHeight() });
            }
            const link = document.createElement("a");
            link.href = URL.createObjectURL(new Blob([await pdfDoc.save()], { type: "application/pdf" }));
            link.download = document.getElementById('fileNameInput').value + ".pdf";
            link.click();
            status.textContent = "âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸!"; setTimeout(() => status.style.display = 'none', 3000);
        } catch (e) { alert("Ø®Ø·Ø£: " + e.message); status.style.display = 'none'; }
    }

    async function saveAsImages() {
        const status = document.getElementById('status'); status.style.display = 'block';
        status.textContent = "Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±...";
        try {
            for (let i = 0; i < items.length; i++) {
                const canvas = await getProcessedCanvas(items[i]);
                const blob = await new Promise(res => canvas.toBlob(res, 'image/jpeg', 0.9));
                const name = (items[i].customName || `page_${i+1}`).replace(/[/\\?%*:|"<>]/g, '-') + ".jpg";
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = name;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                await new Promise(r => setTimeout(r, 400));
            }
            status.textContent = "âœ… ØªÙ…Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ©!"; setTimeout(() => status.style.display = 'none', 3000);
        } catch (e) { alert("Ø®Ø·Ø£: " + e.message); status.style.display = 'none'; }
    }

    function rotateItem(i) { items[i].rotation = (items[i].rotation + 90) % 360; renderUI(); }
    function removeItem(i) { items.splice(i, 1); renderUI(); }
    async function genSimpleThumb(t) { const canvas = document.createElement('canvas'); canvas.width = 100; canvas.height = 100; const ctx = canvas.getContext('2d'); ctx.fillStyle = '#eee'; ctx.fillRect(0,0,100,100); ctx.fillStyle = '#333'; ctx.font = '12px Arial'; ctx.textAlign = 'center'; ctx.fillText(t.substring(0,20), 50, 55); return canvas.toDataURL(); }
</script>
</body>
</html>
