--- START OF UPDATED FILE NewcustomerAPP.html ---

<!DOCTYPE html>
<html lang="en" dir="rtl"> <!-- Default RTL for Arabic start -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PDF Data Form</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf_viewer.min.css">
    
    <style>
        :root {
            --primary: #2563eb;
            --bg-panel: #f8f9fa;
            --border: #e5e7eb;
            --text-dark: #1f2937;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body { 
            margin: 0; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #525659; /* PDF Viewer Grey */
            height: 100vh;
            display: flex;
            flex-direction: row; 
            overflow: hidden;
        }

        /* --- PDF Viewer (Left/Top) --- */
        #viewer-container {
            flex: 1;
            height: 100%;
            overflow-y: auto;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            touch-action: pan-x pan-y; 
            background-color: #525659;
        }

        .pdf-page-container {
            position: relative;
            margin-bottom: 15px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            background: white;
            user-select: none; 
        }

        canvas { display: block; width: 100%; height: auto; }

        /* Red Marker Dot */
        .marker {
            position: absolute;
            width: 12px;
            height: 12px;
            background: rgba(220, 38, 38, 0.9); /* Red */
            border: 2px solid white;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
            z-index: 10;
        }

        /* --- Floating Input on PDF --- */
        .floating-input-wrapper {
            position: absolute;
            background: white;
            padding: 4px;
            border-radius: 4px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.4);
            display: flex;
            gap: 4px;
            z-index: 1000;
            transform: translate(-50%, -125%);
            min-width: 180px;
        }
        
        .floating-input-wrapper::after {
            content: ''; position: absolute; top: 100%; left: 50%; margin-left: -6px;
            border-width: 6px; border-style: solid; border-color: white transparent transparent transparent;
        }

        .floating-input-wrapper input {
            flex: 1; border: 1px solid #ccc; padding: 6px; border-radius: 3px; outline: none;
        }

        .floating-input-wrapper button {
            background: var(--primary); color: white; border: none; padding: 0 12px; border-radius: 3px; font-weight: bold;
        }

        /* --- Sidebar (Form Area) --- */
        #sidebar {
            width: 350px;
            background: white;
            display: flex;
            flex-direction: column;
            z-index: 20;
            border-inline-start: 1px solid #ccc;
        }

        .sidebar-header {
            padding: 10px;
            background: #f1f5f9;
            border-bottom: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .zoom-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            background: #e2e8f0;
            padding: 5px;
            border-radius: 6px;
        }

        .zoom-btn {
            background: white;
            border: 1px solid #cbd5e1;
            padding: 2px 10px;
            cursor: pointer;
            font-weight: bold;
            border-radius: 4px;
        }
        .zoom-btn:hover { background: #f8fafc; }

        .lang-btn {
            background: #334155;
            color: white;
            border: none;
            padding: 4px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .action-btn { 
            width: 100%; padding: 10px; cursor: pointer; 
            background: var(--primary); color: white; border: none; 
            border-radius: 6px; font-weight: 600;
        }
        .action-btn:active { opacity: 0.9; }

        /* --- Form Table Layout --- */
        #form-container {
            flex: 1;
            overflow-y: auto;
            padding: 0;
        }

        .form-row {
            display: grid;
            /* Label | Input | Controls */
            grid-template-columns: 110px 1fr 30px; 
            border-bottom: 1px solid #eee;
            align-items: stretch;
            min-height: 40px;
        }

        .form-label {
            background: #f8fafc;
            padding: 8px;
            font-size: 12px;
            font-weight: bold;
            color: #475569;
            display: flex;
            align-items: center;
            border-inline-end: 1px solid #eee;
            word-break: break-word;
        }

        .form-value {
            padding: 0;
            display: flex;
        }

        .form-value input {
            width: 100%;
            border: none;
            padding: 5px 8px;
            font-family: monospace;
            font-size: 13px;
            color: #000;
            outline: none;
        }
        .form-value input:focus { background: #f0f9ff; }

        .form-controls {
            display: flex;
            flex-direction: column;
            justify-content: center;
            background: #fff;
        }

        .mini-btn {
            border: none; background: transparent; 
            font-size: 10px; color: #94a3b8; cursor: pointer;
            height: 13px; padding: 0; line-height: 1;
        }
        .mini-btn:hover { color: var(--primary); font-weight: bold; }
        .btn-clear { color: #ef4444; font-size: 14px; height: 14px; margin-top: 2px;}

        /* Active/Filled State */
        .form-row.filled .form-label { color: var(--primary); }

        /* --- Mobile Layout --- */
        @media (max-width: 768px) {
            body { flex-direction: column; }
            #viewer-container { width: 100%; padding: 10px; }
            #sidebar { 
                width: 100%; 
                height: 50vh; 
                border-inline-start: none;
                border-top: 2px solid #ccc;
            }
            .form-row { grid-template-columns: 90px 1fr 30px; }
        }

        /* Loader & Overlay */
        #upload-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #111; z-index: 2000; display: flex;
            flex-direction: column; justify-content: center; align-items: center; color: white;
        }
        .loader {
            border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%;
            width: 40px; height: 40px; animation: spin 1s linear infinite; display: none; margin-top: 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <!-- Upload Screen -->
    <div id="upload-overlay">
        <h2>ðŸ“‚ Open PDF</h2>
        <input type="file" id="file-input" accept="application/pdf" style="margin-top:20px;">
        <div class="loader" id="loader"></div>
    </div>

    <!-- Viewer -->
    <div id="viewer-container"></div>

    <!-- Sidebar Form -->
    <div id="sidebar">
        <div class="sidebar-header">
            <div class="header-top">
                <button class="lang-btn" onclick="toggleLanguage()">Ø¹Ø±Ø¨ÙŠ / EN</button>
                <div style="font-size:12px; color:#555;">Filled: <span id="filled-count">0</span>/12</div>
            </div>

            <!-- Zoom Controls Added Here -->
            <div class="zoom-controls">
                <button class="zoom-btn" onclick="changeZoom(-0.2)">âˆ’</button>
                <span id="zoom-level" style="font-size:12px; font-weight:bold; min-width:40px; text-align:center;">150%</span>
                <button class="zoom-btn" onclick="changeZoom(0.2)">+</button>
            </div>

            <button class="action-btn" id="copy-btn" onclick="copyAll()">Copy Data (-)</button>
        </div>
        
        <div id="form-container">
            <!-- Table Rows will be generated here by JS -->
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        /* --- Configuration --- */
        const fieldsConfig = [
            { key: 'store', ar: 'Ø§Ø³Ù… Ø§Ù„Ù…Ø­Ù„', en: 'Store Name' },
            { key: 'cr', ar: 'Ø±Ù‚Ù… Ø§Ù„Ø³Ø¬Ù„', en: 'CR Number' },
            { key: 'license', ar: 'Ø±Ù‚Ù… Ø§Ù„Ø±Ø®ØµØ©', en: 'License Num' },
            { key: 'tax', ar: 'Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¶Ø±ÙŠØ¨ÙŠ', en: 'Tax Number' },
            { key: 'mobile', ar: 'Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„', en: 'Mobile Num' },
            { key: 'zip', ar: 'Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø¨Ø±ÙŠØ¯ÙŠ', en: 'Zip Code' },
            { key: 'building', ar: 'Ø±Ù‚Ù… Ø§Ù„Ù…Ø¨Ù†ÙŠ', en: 'Building Num' },
            { key: 'additional', ar: 'Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø§Ø¶Ø§ÙÙŠ', en: 'Additional Num' },
            { key: 'district', ar: 'Ø§Ø³Ù… Ø§Ù„Ø­ÙŠ', en: 'District' },
            { key: 'street', ar: 'Ø§Ø³Ù… Ø§Ù„Ø´Ø§Ø±Ø¹', en: 'Street' },
            { key: 'short', ar: 'Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø®ØªØµØ±', en: 'Short Address' },
            { key: 'coords', ar: 'Ø§Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹', en: 'Coordinates' }
        ];

        // Marker data now includes page index and percentage coordinates for scaling
        let formData = new Array(12).fill(null).map(() => ({ value: '', markerData: null }));
        let currentLang = 'ar';
        let activeFloatingInput = null;
        let pdfDoc = null;
        let currentScale = 1.5;

        // --- DOM Elements ---
        const formContainer = document.getElementById('form-container');
        const filledCount = document.getElementById('filled-count');
        const fileInput = document.getElementById('file-input');
        const viewer = document.getElementById('viewer-container');
        const overlay = document.getElementById('upload-overlay');
        const loader = document.getElementById('loader');
        const zoomLevelEl = document.getElementById('zoom-level');

        // --- Initialization ---
        function initForm() {
            formContainer.innerHTML = '';
            fieldsConfig.forEach((field, index) => {
                const row = document.createElement('div');
                row.className = 'form-row';
                row.id = `row-${index}`;
                
                row.innerHTML = `
                    <div class="form-label">${currentLang === 'ar' ? field.ar : field.en}</div>
                    <div class="form-value">
                        <input type="text" id="input-${index}" 
                            oninput="updateValueManually(${index}, this.value)" 
                            placeholder="...">
                    </div>
                    <div class="form-controls">
                        <button class="mini-btn" onclick="moveValue(${index}, -1)">â–²</button>
                        <button class="mini-btn btn-clear" onclick="clearRow(${index})">Ã—</button>
                        <button class="mini-btn" onclick="moveValue(${index}, 1)">â–¼</button>
                    </div>
                `;
                formContainer.appendChild(row);
            });
            updateFormUI();
        }

        // --- Zoom Logic ---
        function changeZoom(delta) {
            if (!pdfDoc) return;
            currentScale = Math.min(Math.max(currentScale + delta, 0.5), 3.0);
            zoomLevelEl.innerText = Math.round(currentScale * 100) + "%";
            renderPDF();
        }

        // --- PDF Rendering ---
        fileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if(!file) return;
            loader.style.display = 'block';
            
            const reader = new FileReader();
            reader.onload = async function() {
                const typedarray = new Uint8Array(this.result);
                pdfDoc = await pdfjsLib.getDocument(typedarray).promise;
                overlay.style.display = 'none';
                initForm();
                renderPDF();
            };
            reader.readAsArrayBuffer(file);
        });

        async function renderPDF() {
            if (!pdfDoc) return;
            viewer.innerHTML = ''; // Clear current pages
            
            for(let i=1; i<=pdfDoc.numPages; i++) {
                const page = await pdfDoc.getPage(i);
                const viewport = page.getViewport({scale: currentScale});
                
                const wrapper = document.createElement('div');
                wrapper.className = 'pdf-page-container';
                wrapper.id = `page-container-${i-1}`; // 0-indexed
                wrapper.style.width = viewport.width + "px";
                wrapper.style.height = viewport.height + "px";
                
                const canvas = document.createElement('canvas');
                canvas.width = viewport.width;
                canvas.height = viewport.height;
                const ctx = canvas.getContext('2d');
                
                wrapper.appendChild(canvas);
                viewer.appendChild(wrapper);
                
                wrapper.addEventListener('click', (e) => handleMapClick(e, wrapper, i-1));
                
                await page.render({canvasContext: ctx, viewport: viewport}).promise;

                // Re-draw any existing markers for this page
                recreateMarkers(i-1, wrapper);
            }
        }

        function recreateMarkers(pageIdx, wrapper) {
            formData.forEach((data, index) => {
                if (data.markerData && data.markerData.pageIdx === pageIdx) {
                    const marker = document.createElement('div');
                    marker.className = 'marker';
                    marker.style.left = data.markerData.percentX + '%';
                    marker.style.top = data.markerData.percentY + '%';
                    wrapper.appendChild(marker);
                    // Update reference
                    formData[index].markerElement = marker;
                }
            });
        }

        // --- Interaction Logic ---
        function handleMapClick(e, wrapper, pageIdx) {
            if(['INPUT','BUTTON'].includes(e.target.tagName)) return;
            if(activeFloatingInput) activeFloatingInput.remove();

            const rect = wrapper.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            createFloatingInput(wrapper, x, y, pageIdx);
        }

        function createFloatingInput(parent, x, y, pageIdx) {
            const div = document.createElement('div');
            div.className = 'floating-input-wrapper';
            div.style.left = x + 'px';
            div.style.top = y + 'px';

            const input = document.createElement('input');
            input.type = 'text';
            setTimeout(() => input.focus(), 50);

            const btn = document.createElement('button');
            btn.innerHTML = 'âœ”';

            const submit = () => {
                if(input.value.trim()) {
                    assignToNextEmptySlot(input.value, x, y, parent, pageIdx);
                }
                div.remove();
                activeFloatingInput = null;
            };

            btn.onclick = submit;
            input.addEventListener('keydown', (e) => { if(e.key === 'Enter') submit(); });

            div.appendChild(input);
            div.appendChild(btn);
            parent.appendChild(div);
            activeFloatingInput = div;
        }

        function assignToNextEmptySlot(text, x, y, parent, pageIdx) {
            const emptyIndex = formData.findIndex(item => item.value === '');
            
            if(emptyIndex === -1) {
                alert("All fields are full!");
                return;
            }

            // Calculate percentage coordinates
            const percentX = (x / parent.offsetWidth) * 100;
            const percentY = (y / parent.offsetHeight) * 100;

            const marker = document.createElement('div');
            marker.className = 'marker';
            marker.style.left = percentX + '%';
            marker.style.top = percentY + '%';
            parent.appendChild(marker);

            formData[emptyIndex] = { 
                value: text, 
                markerElement: marker,
                markerData: { percentX, percentY, pageIdx } 
            };
            
            updateFormUI();
        }

        function clearRow(index) {
            if(formData[index].markerElement) {
                formData[index].markerElement.remove();
            }
            formData[index] = { value: '', markerElement: null, markerData: null };
            updateFormUI();
        }

        // --- Logic Shared with Original ---
        function updateValueManually(index, newVal) {
            formData[index].value = newVal;
            updateFormUI(false);
        }

        function moveValue(index, direction) {
            const newIndex = index + direction;
            if(newIndex < 0 || newIndex >= 12) return;
            const temp = formData[index];
            formData[index] = formData[newIndex];
            formData[newIndex] = temp;
            updateFormUI();
        }

        function updateFormUI(refreshInputs = true) {
            let count = 0;
            formData.forEach((data, i) => {
                const row = document.getElementById(`row-${i}`);
                if(refreshInputs) {
                    document.getElementById(`input-${i}`).value = data.value;
                }
                if(data.value) { row.classList.add('filled'); count++; } 
                else { row.classList.remove('filled'); }
            });
            filledCount.innerText = count;
        }

        function toggleLanguage() {
            currentLang = currentLang === 'ar' ? 'en' : 'ar';
            document.documentElement.dir = currentLang === 'ar' ? 'rtl' : 'ltr';
            initForm();
            formData.forEach((data, i) => {
                const input = document.getElementById(`input-${i}`);
                if(input && data.value) input.value = data.value;
            });
        }

        function copyAll() {
            const textToCopy = formData.map(d => d.value.trim()).join('-');
            const txt = document.createElement('textarea');
            txt.value = textToCopy;
            txt.style.position = 'fixed'; txt.style.left = '-9999px';
            document.body.appendChild(txt);
            txt.select();
            try {
                document.execCommand('copy');
                const btn = document.getElementById('copy-btn');
                const old = btn.innerText;
                btn.innerText = "COPIED! âœ”";
                btn.style.background = "#059669";
                setTimeout(() => { btn.innerText = old; btn.style.background = ""; }, 1500);
            } catch(e) {}
            document.body.removeChild(txt);
        }

        initForm();
    </script>
</body>
</html>