<!DOCTYPE html>
<html lang="en" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PDF Data Form</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf_viewer.min.css">
    
    <style>
        :root {
            --primary: #2563eb;
            --bg-panel: #f8f9fa;
            --border: #e5e7eb;
            --text-dark: #1f2937;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body { 
            margin: 0; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #525659;
            height: 100vh;
            display: flex;
            flex-direction: row; 
            overflow: hidden;
        }

        /* --- PDF Viewer (Left/Top) --- */
        #viewer-container {
            flex: 1;
            height: 100%;
            overflow: auto; /* Changed to auto to handle both X and Y */
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            background-color: #525659;
            min-width: 0; /* Important flex fix for desktop mode */
        }

        .pdf-page-container {
            position: relative;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            background: white;
            user-select: none;
            line-height: 0; /* Removes extra spacing under canvas */
        }

        canvas { 
            max-width: none; /* Allow canvas to be larger than container if zoomed */
            display: block; 
        }

        .marker {
            position: absolute;
            width: 14px;
            height: 14px;
            background: #ef4444;
            border: 2px solid white;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
            z-index: 10;
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
        }

        .floating-input-wrapper {
            position: absolute;
            background: white;
            padding: 5px;
            border-radius: 6px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            display: flex;
            gap: 5px;
            z-index: 1000;
            transform: translate(-50%, -130%);
            min-width: 200px;
            border: 1px solid #ccc;
        }

        /* --- Sidebar (Form Area) --- */
        #sidebar {
            width: 350px;
            min-width: 350px;
            background: white;
            display: flex;
            flex-direction: column;
            z-index: 20;
            border-inline-start: 1px solid #ccc;
            box-shadow: -2px 0 10px rgba(0,0,0,0.1);
        }

        .sidebar-header {
            padding: 12px;
            background: #f1f5f9;
            border-bottom: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .zoom-controls {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #fff;
            padding: 4px 8px;
            border-radius: 6px;
            border: 1px solid #cbd5e1;
        }

        .zoom-btn {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            padding: 4px 12px;
            cursor: pointer;
            font-weight: bold;
            border-radius: 4px;
            font-size: 16px;
        }
        .zoom-btn:active { background: #e2e8f0; }

        .fit-btn {
            font-size: 11px;
            padding: 4px 8px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .lang-btn {
            background: #334155;
            color: white; border: none; padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 12px;
        }

        .action-btn { 
            width: 100%; padding: 12px; cursor: pointer; 
            background: var(--primary); color: white; border: none; 
            border-radius: 6px; font-weight: 600;
        }

        #form-container { flex: 1; overflow-y: auto; }

        .form-row {
            display: grid;
            grid-template-columns: 110px 1fr 30px; 
            border-bottom: 1px solid #eee;
            min-height: 44px;
        }

        .form-label {
            background: #f8fafc; padding: 8px; font-size: 12px; font-weight: bold;
            color: #475569; display: flex; align-items: center; border-inline-end: 1px solid #eee;
        }

        .form-value input {
            width: 100%; border: none; padding: 10px; font-family: monospace; font-size: 14px; outline: none;
        }

        .form-controls { display: flex; flex-direction: column; border-inline-start: 1px solid #eee; }
        .mini-btn { border: none; background: transparent; font-size: 12px; color: #94a3b8; cursor: pointer; flex: 1; }
        .btn-clear { color: #ef4444; font-weight: bold; }

        .form-row.filled { background: #f0f9ff; }
        .form-row.filled .form-label { color: var(--primary); }

        @media (max-width: 768px) {
            body { flex-direction: column; }
            #sidebar { width: 100%; height: 45vh; min-width: 100%; border-top: 2px solid #ccc; }
            #viewer-container { flex: 1; }
        }

        #upload-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #111; z-index: 2000; display: flex;
            flex-direction: column; justify-content: center; align-items: center; color: white;
        }
        .loader {
            border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%;
            width: 40px; height: 40px; animation: spin 1s linear infinite; display: none; margin-top: 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="upload-overlay">
        <h2>ðŸ“‚ Open PDF</h2>
        <input type="file" id="file-input" accept="application/pdf">
        <div class="loader" id="loader"></div>
    </div>

    <div id="viewer-container"></div>

    <div id="sidebar">
        <div class="sidebar-header">
            <div class="header-top">
                <button class="lang-btn" onclick="toggleLanguage()">Ø¹Ø±Ø¨ÙŠ / EN</button>
                <div style="font-size:12px; color:#555;">Filled: <span id="filled-count">0</span>/12</div>
            </div>

            <div class="zoom-controls">
                <button class="zoom-btn" onclick="changeZoom(-0.2)">âˆ’</button>
                <span id="zoom-level" style="font-size:13px; font-weight:bold;">100%</span>
                <button class="zoom-btn" onclick="changeZoom(0.2)">+</button>
                <button class="fit-btn" onclick="fitToWidth()">Fit Width</button>
            </div>

            <button class="action-btn" id="copy-btn" onclick="copyAll()">Copy Data (-)</button>
        </div>
        
        <div id="form-container"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        const fieldsConfig = [
            { key: 'store', ar: 'Ø§Ø³Ù… Ø§Ù„Ù…Ø­Ù„', en: 'Store Name' },
            { key: 'cr', ar: 'Ø±Ù‚Ù… Ø§Ù„Ø³Ø¬Ù„', en: 'CR Number' },
            { key: 'license', ar: 'Ø±Ù‚Ù… Ø§Ù„Ø±Ø®ØµØ©', en: 'License Num' },
            { key: 'tax', ar: 'Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¶Ø±ÙŠØ¨ÙŠ', en: 'Tax Number' },
            { key: 'mobile', ar: 'Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„', en: 'Mobile Num' },
            { key: 'zip', ar: 'Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø¨Ø±ÙŠØ¯ÙŠ', en: 'Zip Code' },
            { key: 'building', ar: 'Ø±Ù‚Ù… Ø§Ù„Ù…Ø¨Ù†ÙŠ', en: 'Building Num' },
            { key: 'additional', ar: 'Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø§Ø¶Ø§ÙÙŠ', en: 'Additional Num' },
            { key: 'district', ar: 'Ø§Ø³Ù… Ø§Ù„Ø­ÙŠ', en: 'District' },
            { key: 'street', ar: 'Ø§Ø³Ù… Ø§Ù„Ø´Ø§Ø±Ø¹', en: 'Street' },
            { key: 'short', ar: 'Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø®ØªØµØ±', en: 'Short Address' },
            { key: 'coords', ar: 'Ø§Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹', en: 'Coordinates' }
        ];

        let formData = new Array(12).fill(null).map(() => ({ value: '', markerData: null }));
        let currentLang = 'ar';
        let activeFloatingInput = null;
        let pdfDoc = null;
        let currentScale = 1.2;

        const formContainer = document.getElementById('form-container');
        const filledCount = document.getElementById('filled-count');
        const fileInput = document.getElementById('file-input');
        const viewer = document.getElementById('viewer-container');
        const overlay = document.getElementById('upload-overlay');
        const loader = document.getElementById('loader');
        const zoomLevelEl = document.getElementById('zoom-level');

        function initForm() {
            formContainer.innerHTML = '';
            fieldsConfig.forEach((field, index) => {
                const row = document.createElement('div');
                row.className = 'form-row';
                row.id = `row-${index}`;
                row.innerHTML = `
                    <div class="form-label">${currentLang === 'ar' ? field.ar : field.en}</div>
                    <div class="form-value"><input type="text" id="input-${index}" oninput="updateValueManually(${index}, this.value)" placeholder="..."></div>
                    <div class="form-controls">
                        <button class="mini-btn" onclick="moveValue(${index}, -1)">â–²</button>
                        <button class="mini-btn btn-clear" onclick="clearRow(${index})">Ã—</button>
                        <button class="mini-btn" onclick="moveValue(${index}, 1)">â–¼</button>
                    </div>`;
                formContainer.appendChild(row);
            });
            updateFormUI();
        }

        async function fitToWidth() {
            if (!pdfDoc) return;
            const page = await pdfDoc.getPage(1);
            const viewport = page.getViewport({ scale: 1 });
            // Width of viewer container minus padding
            const availableWidth = viewer.clientWidth - 40; 
            currentScale = availableWidth / viewport.width;
            zoomLevelEl.innerText = Math.round(currentScale * 100) + "%";
            renderPDF();
        }

        function changeZoom(delta) {
            if (!pdfDoc) return;
            currentScale = Math.min(Math.max(currentScale + delta, 0.3), 4.0);
            zoomLevelEl.innerText = Math.round(currentScale * 100) + "%";
            renderPDF();
        }

        fileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if(!file) return;
            loader.style.display = 'block';
            const reader = new FileReader();
            reader.onload = async function() {
                const typedarray = new Uint8Array(this.result);
                pdfDoc = await pdfjsLib.getDocument(typedarray).promise;
                overlay.style.display = 'none';
                initForm();
                await fitToWidth(); // Auto fit on load
            };
            reader.readAsArrayBuffer(file);
        });

        async function renderPDF() {
            if (!pdfDoc) return;
            viewer.innerHTML = '';
            for(let i=1; i<=pdfDoc.numPages; i++) {
                const page = await pdfDoc.getPage(i);
                const viewport = page.getViewport({scale: currentScale});
                const wrapper = document.createElement('div');
                wrapper.className = 'pdf-page-container';
                wrapper.style.width = viewport.width + "px";
                wrapper.style.height = viewport.height + "px";
                
                const canvas = document.createElement('canvas');
                canvas.width = viewport.width;
                canvas.height = viewport.height;
                wrapper.appendChild(canvas);
                viewer.appendChild(wrapper);
                
                wrapper.addEventListener('click', (e) => handleMapClick(e, wrapper, i-1));
                await page.render({canvasContext: canvas.getContext('2d'), viewport: viewport}).promise;
                recreateMarkers(i-1, wrapper);
            }
        }

        function recreateMarkers(pageIdx, wrapper) {
            formData.forEach((data, index) => {
                if (data.markerData && data.markerData.pageIdx === pageIdx) {
                    const marker = document.createElement('div');
                    marker.className = 'marker';
                    marker.style.left = data.markerData.percentX + '%';
                    marker.style.top = data.markerData.percentY + '%';
                    wrapper.appendChild(marker);
                    formData[index].markerElement = marker;
                }
            });
        }

        function handleMapClick(e, wrapper, pageIdx) {
            if(['INPUT','BUTTON'].includes(e.target.tagName)) return;
            if(activeFloatingInput) activeFloatingInput.remove();
            const rect = wrapper.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            createFloatingInput(wrapper, x, y, pageIdx);
        }

        function createFloatingInput(parent, x, y, pageIdx) {
            const div = document.createElement('div');
            div.className = 'floating-input-wrapper';
            div.style.left = x + 'px';
            div.style.top = y + 'px';
            const input = document.createElement('input');
            input.type = 'text';
            input.style.flex = "1";
            input.style.padding = "8px";
            setTimeout(() => input.focus(), 50);
            const btn = document.createElement('button');
            btn.innerHTML = 'âœ”';
            btn.style.padding = "0 15px";
            btn.style.background = "var(--primary)";
            btn.style.color = "white";
            btn.style.border = "none";
            btn.style.borderRadius = "4px";

            const submit = () => {
                if(input.value.trim()) assignToNextEmptySlot(input.value, x, y, parent, pageIdx);
                div.remove();
                activeFloatingInput = null;
            };
            btn.onclick = submit;
            input.onkeydown = (e) => { if(e.key === 'Enter') submit(); };
            div.appendChild(input); div.appendChild(btn);
            parent.appendChild(div);
            activeFloatingInput = div;
        }

        function assignToNextEmptySlot(text, x, y, parent, pageIdx) {
            const idx = formData.findIndex(item => item.value === '');
            if(idx === -1) return alert("Full!");
            const px = (x / parent.offsetWidth) * 100;
            const py = (y / parent.offsetHeight) * 100;
            const marker = document.createElement('div');
            marker.className = 'marker';
            marker.style.left = px + '%'; marker.style.top = py + '%';
            parent.appendChild(marker);
            formData[idx] = { value: text, markerElement: marker, markerData: { percentX: px, percentY: py, pageIdx } };
            updateFormUI();
        }

        function clearRow(index) {
            if(formData[index].markerElement) formData[index].markerElement.remove();
            formData[index] = { value: '', markerElement: null, markerData: null };
            updateFormUI();
        }

        function updateValueManually(index, val) { formData[index].value = val; updateFormUI(false); }

        function moveValue(index, dir) {
            const newIdx = index + dir;
            if(newIdx < 0 || newIdx >= 12) return;
            [formData[index], formData[newIdx]] = [formData[newIdx], formData[index]];
            updateFormUI();
        }

        function updateFormUI(refresh = true) {
            let count = 0;
            formData.forEach((data, i) => {
                const row = document.getElementById(`row-${i}`);
                if(refresh) document.getElementById(`input-${i}`).value = data.value;
                if(data.value) { row.classList.add('filled'); count++; } else row.classList.remove('filled');
            });
            filledCount.innerText = count;
        }

        function toggleLanguage() {
            currentLang = currentLang === 'ar' ? 'en' : 'ar';
            document.documentElement.dir = currentLang === 'ar' ? 'rtl' : 'ltr';
            const values = formData.map(d => d.value);
            initForm();
            values.forEach((v, i) => { if(v) document.getElementById(`input-${i}`).value = v; });
        }

        function copyAll() {
            const text = formData.map(d => d.value.trim()).join('-');
            navigator.clipboard.writeText(text).then(() => {
                const btn = document.getElementById('copy-btn');
                const old = btn.innerText;
                btn.innerText = "COPIED!";
                setTimeout(() => btn.innerText = old, 1000);
            });
        }

        initForm();
    </script>
</body>
</html>
